name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run tests
        run: |
          go test -v -race ./internal/...
          go test -v -race ./test/acceptance/...

      - name: Build release binaries
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p dist

          # Linux amd64
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X main.version=${VERSION}" \
            -o dist/render-linux-amd64 ./cmd/render

          # Linux arm64
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X main.version=${VERSION}" \
            -o dist/render-linux-arm64 ./cmd/render

          # macOS amd64
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w -X main.version=${VERSION}" \
            -o dist/render-darwin-amd64 ./cmd/render

          # macOS arm64
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w -X main.version=${VERSION}" \
            -o dist/render-darwin-arm64 ./cmd/render

          # Windows amd64
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -X main.version=${VERSION}" \
            -o dist/render-windows-amd64.exe ./cmd/render

      - name: Create archives
        run: |
          cd dist

          # Create tar.gz for Linux and macOS
          for f in render-linux-* render-darwin-*; do
            if [ -f "$f" ]; then
              tar -czvf "${f}.tar.gz" "$f"
              rm "$f"
            fi
          done

          # Create zip for Windows
          for f in render-windows-*.exe; do
            if [ -f "$f" ]; then
              zip "${f%.exe}.zip" "$f"
              rm "$f"
            fi
          done

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums.txt

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}

          # Determine if prerelease
          PRERELEASE_FLAG=""
          if [[ "$VERSION" == *"-rc"* ]] || [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-alpha"* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          # Create release with auto-generated notes
          gh release create "$VERSION" \
            --generate-notes \
            $PRERELEASE_FLAG \
            dist/*.tar.gz \
            dist/*.zip \
            dist/checksums.txt
