project: myapp
region: us-west-2
provider: aws
providerVersion: "~> 5.0"
terraformVersion: ">= 1.6"

modules:
  - name: vpc
    description: VPC with public and private subnets
    variables:
      - name: cidr_block
        type: string
        default: '"10.0.0.0/16"'
      - name: availability_zones
        type: list(string)
        default: '["us-west-2a", "us-west-2b", "us-west-2c"]'
      - name: enable_nat_gateway
        type: bool
        default: "true"
    outputs:
      - name: vpc_id
        value: aws_vpc.main.id
      - name: private_subnet_ids
        value: aws_subnet.private[*].id
      - name: public_subnet_ids
        value: aws_subnet.public[*].id

  - name: eks
    description: Managed Kubernetes cluster
    variables:
      - name: cluster_name
        type: string
      - name: vpc_id
        type: string
      - name: subnet_ids
        type: list(string)
      - name: node_instance_type
        type: string
        default: '"t3.medium"'
      - name: node_desired_count
        type: number
        default: "2"
    outputs:
      - name: cluster_endpoint
        value: aws_eks_cluster.main.endpoint
      - name: cluster_name
        value: aws_eks_cluster.main.name

  - name: rds
    description: PostgreSQL database
    variables:
      - name: identifier
        type: string
      - name: vpc_id
        type: string
      - name: subnet_ids
        type: list(string)
      - name: instance_class
        type: string
        default: '"db.t3.micro"'
      - name: allocated_storage
        type: number
        default: "20"
      - name: engine_version
        type: string
        default: '"15.4"'
    outputs:
      - name: endpoint
        value: aws_db_instance.main.endpoint
      - name: database_name
        value: aws_db_instance.main.db_name

environments:
  - name: dev
    settings:
      vpc:
        cidr_block: "10.0.0.0/16"
        enable_nat_gateway: false
      eks:
        node_instance_type: "t3.small"
        node_desired_count: 1
      rds:
        instance_class: "db.t3.micro"
        allocated_storage: 20

  - name: staging
    settings:
      vpc:
        cidr_block: "10.1.0.0/16"
        enable_nat_gateway: true
      eks:
        node_instance_type: "t3.medium"
        node_desired_count: 2
      rds:
        instance_class: "db.t3.small"
        allocated_storage: 50

  - name: prod
    settings:
      vpc:
        cidr_block: "10.2.0.0/16"
        enable_nat_gateway: true
      eks:
        node_instance_type: "t3.large"
        node_desired_count: 3
      rds:
        instance_class: "db.r6g.large"
        allocated_storage: 100
