# {{ .name }} environment configuration
# Generated by render - regenerate after changes to infrastructure.yaml

terraform {
  required_version = "{{ $.terraformVersion }}"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "{{ $.providerVersion }}"
    }
  }

  backend "s3" {
    bucket         = "{{ $.project }}-terraform-state"
    key            = "{{ .name }}/terraform.tfstate"
    region         = "{{ $.region }}"
    encrypt        = true
    dynamodb_table = "{{ $.project }}-terraform-locks"
  }
}

provider "aws" {
  region = var.region

  default_tags {
    tags = {
      Project     = "{{ $.project }}"
      Environment = "{{ .name }}"
      ManagedBy   = "terraform"
    }
  }
}

locals {
  environment = "{{ .name }}"
}

module "vpc" {
  source = "../../modules/vpc"

  project     = var.project
  environment = local.environment
  cidr_block  = "{{ .settings.vpc.cidr_block }}"
{{- if .settings.vpc.enable_nat_gateway }}
  enable_nat_gateway = {{ .settings.vpc.enable_nat_gateway }}
{{- end }}
}

module "eks" {
  source = "../../modules/eks"

  project            = var.project
  environment        = local.environment
  cluster_name       = "${var.project}-{{ .name }}"
  vpc_id             = module.vpc.vpc_id
  subnet_ids         = module.vpc.private_subnet_ids
  node_instance_type = "{{ .settings.eks.node_instance_type }}"
  node_desired_count = {{ .settings.eks.node_desired_count }}
}

module "rds" {
  source = "../../modules/rds"

  project           = var.project
  environment       = local.environment
  identifier        = "${var.project}-{{ .name }}"
  vpc_id            = module.vpc.vpc_id
  subnet_ids        = module.vpc.private_subnet_ids
  instance_class    = "{{ .settings.rds.instance_class }}"
  allocated_storage = {{ .settings.rds.allocated_storage }}
}
