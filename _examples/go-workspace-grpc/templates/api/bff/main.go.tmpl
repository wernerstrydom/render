package main

import (
	"encoding/json"
	"flag"
	"log"
	"net/http"
)

var (
	port = flag.Int("port", {{ .httpPort }}, "The HTTP server port")
)

func main() {
	flag.Parse()

	mux := http.NewServeMux()

	// Health check endpoint
	mux.HandleFunc("GET /health", func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Content-Type", "application/json")
		json.NewEncoder(w).Encode(map[string]string{"status": "healthy"})
	})
{{ range .entities }}
	// {{ .name }} endpoints
	mux.HandleFunc("GET /api/{{ $.name }}/{{ .name | lower }}s", list{{ .name }}sHandler)
	mux.HandleFunc("GET /api/{{ $.name }}/{{ .name | lower }}s/{id}", get{{ .name }}Handler)
	mux.HandleFunc("POST /api/{{ $.name }}/{{ .name | lower }}s", create{{ .name }}Handler)
	mux.HandleFunc("PUT /api/{{ $.name }}/{{ .name | lower }}s/{id}", update{{ .name }}Handler)
	mux.HandleFunc("DELETE /api/{{ $.name }}/{{ .name | lower }}s/{id}", delete{{ .name }}Handler)
{{ end }}
	log.Printf("{{ .name | pascalCase }} BFF listening on :%d", *port)
	log.Fatal(http.ListenAndServe(fmt.Sprintf(":%d", *port), mux))
}
{{ range .entities }}
func list{{ .name }}sHandler(w http.ResponseWriter, r *http.Request) {
	// TODO: Call gRPC service and return JSON
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode([]interface{}{})
}

func get{{ .name }}Handler(w http.ResponseWriter, r *http.Request) {
	id := r.PathValue("id")
	// TODO: Call gRPC service and return JSON
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(map[string]string{"id": id})
}

func create{{ .name }}Handler(w http.ResponseWriter, r *http.Request) {
	// TODO: Parse body, call gRPC service, return JSON
	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(http.StatusCreated)
	json.NewEncoder(w).Encode(map[string]string{"status": "created"})
}

func update{{ .name }}Handler(w http.ResponseWriter, r *http.Request) {
	id := r.PathValue("id")
	// TODO: Parse body, call gRPC service, return JSON
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(map[string]string{"id": id, "status": "updated"})
}

func delete{{ .name }}Handler(w http.ResponseWriter, r *http.Request) {
	// TODO: Call gRPC service
	w.WriteHeader(http.StatusNoContent)
}
{{ end }}
