# Makefile for {{ .name }} Go workspace
# Generated by render - do not edit manually

.PHONY: all build test lint clean tidy fmt vet help
.PHONY:{{ range .modules }} build-{{ .name }} test-{{ .name }} lint-{{ .name }} clean-{{ .name }}{{ end }}
{{ if .dockerRegistry }}.PHONY:{{ range .modules }}{{ if .hasDocker }} docker-{{ .name }}{{ end }}{{ end }}{{ end }}

# Go settings
GO := go
GOFLAGS := -v
LDFLAGS := {{ .ldflags }}
{{ if .buildTags }}BUILD_TAGS := -tags {{ .buildTags }}{{ end }}

# Version info
VERSION ?= $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
COMMIT := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
BUILD_TIME := $(shell date -u +"%Y-%m-%dT%H:%M:%SZ")
LDFLAGS += -X main.version=$(VERSION) -X main.commit=$(COMMIT) -X main.buildTime=$(BUILD_TIME)

# Docker settings
{{ if .dockerRegistry -}}
DOCKER_REGISTRY := {{ .dockerRegistry }}
DOCKER_TAG ?= $(VERSION)
{{- end }}

# Directories
BIN_DIR := bin
DIST_DIR := dist

#==============================================================================
# Default target
#==============================================================================

all: build

#==============================================================================
# Global targets
#==============================================================================

build:{{ range .modules }} build-{{ .name }}{{ end }}

test:{{ range .modules }} test-{{ .name }}{{ end }}

lint:{{ range .modules }} lint-{{ .name }}{{ end }}
	@echo "All modules linted successfully"

clean:{{ range .modules }} clean-{{ .name }}{{ end }}
	rm -rf $(BIN_DIR) $(DIST_DIR)

tidy:
	@for dir in {{ range .modules }}{{ .path }} {{ end }}; do \
		echo "Tidying $$dir..."; \
		(cd $$dir && $(GO) mod tidy); \
	done

fmt:
	@gofmt -s -w .

vet:
	@$(GO) vet ./...

#==============================================================================
# Per-module targets
#==============================================================================
{{ range .modules }}
# {{ .name }} ({{ .type }})
build-{{ .name }}:
{{- if eq .type "library" }}
	@echo "Checking {{ .name }}..."
	@(cd {{ .path }} && $(GO) build ./...)
{{- else if eq .type "proto" }}
	@echo "Generating {{ .name }}..."
	@(cd {{ .path }} && buf generate)
{{- else }}
	@echo "Building {{ .name }}..."
	@mkdir -p $(BIN_DIR)
	@(cd {{ .path }} && $(GO) build $(GOFLAGS) $(BUILD_TAGS) -ldflags "$(LDFLAGS)" -o ../../$(BIN_DIR)/{{ .binary }} .)
{{- end }}

test-{{ .name }}:
	@echo "Testing {{ .name }}..."
	@(cd {{ .path }} && $(GO) test -race -cover ./...)

lint-{{ .name }}:
	@echo "Linting {{ .name }}..."
	@(cd {{ .path }} && golangci-lint run)

clean-{{ .name }}:
{{- if .binary }}
	@rm -f $(BIN_DIR)/{{ .binary }}
{{- end }}
	@(cd {{ .path }} && $(GO) clean)
{{ if .hasDocker }}
docker-{{ .name }}:
	@echo "Building Docker image for {{ .name }}..."
	@docker build -t $(DOCKER_REGISTRY)/{{ .name }}:$(DOCKER_TAG) -f {{ .path }}/Dockerfile .
{{ end }}
{{- end }}

#==============================================================================
# Development targets
#==============================================================================
{{ range .modules }}{{ if .port }}
run-{{ .name }}: build-{{ .name }}
	@echo "Running {{ .name }} on port {{ .port }}..."
	@$(BIN_DIR)/{{ .binary }}
{{ end }}{{ end }}

#==============================================================================
# CI/CD targets
#==============================================================================

ci: lint test build

install-tools:
	@echo "Installing development tools..."
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@{{ .golangciVersion }}
{{ if .dockerRegistry }}
docker-push:{{ range .modules }}{{ if .hasDocker }} docker-push-{{ .name }}{{ end }}{{ end }}

{{ range .modules }}{{ if .hasDocker -}}
docker-push-{{ .name }}: docker-{{ .name }}
	@docker push $(DOCKER_REGISTRY)/{{ .name }}:$(DOCKER_TAG)
{{ end }}{{ end }}
{{- end }}

#==============================================================================
# Help
#==============================================================================

help:
	@echo "{{ .name }} Makefile"
	@echo ""
	@echo "Global targets:"
	@echo "  all          Build all modules (default)"
	@echo "  build        Build all modules"
	@echo "  test         Test all modules"
	@echo "  lint         Lint all modules"
	@echo "  clean        Clean all modules and build artifacts"
	@echo "  tidy         Run go mod tidy on all modules"
	@echo "  fmt          Format all Go files"
	@echo "  vet          Run go vet on all packages"
	@echo ""
	@echo "Module targets:"
{{- range .modules }}
	@echo "  build-{{ .name }}	Build {{ .name }} module"
	@echo "  test-{{ .name }}	Test {{ .name }} module"
	@echo "  lint-{{ .name }}	Lint {{ .name }} module"
{{- end }}
	@echo ""
	@echo "Development:"
	@echo "  install-tools  Install development tools"
	@echo "  ci             Run full CI pipeline"
